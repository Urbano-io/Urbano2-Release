name: Deploy to Yak

on:
  push:
    branches:
      - '**' # Run on every push, similar to release workflow
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find Latest Version Directory
        id: find_version
        run: |
          # Find directories that look like versions (e.g., 2.2.1.1)
          # Sort numerically/version-wise to get the latest
          LATEST_VERSION=$(ls -d */ | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/$' | sed 's|/$||' | sort -V | tail -n 1)
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "No version directories found."
            exit 1
          fi
          
          echo "Latest version directory found: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Deploy to Yak
        uses: crashcloud/yak-publish@main
        with:
          package-name: "Urbano2"
          token: ${{ secrets.YAK_TOKEN }}
          # Pointing to the version directory where manifest.yml and yak file reside
          build-path: "${{ steps.find_version.outputs.version }}/**"
          publish: 'production' # Publish to live server
          platform: 'any' # Or specific if needed, but 'any' is good for .gha usually

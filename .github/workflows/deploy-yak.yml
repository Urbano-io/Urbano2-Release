name: Deploy to Yak

on:
  push:
    branches:
      - '**' # Run on every push, similar to release workflow
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find Latest Version Directory
        id: find_version
        shell: pwsh
        run: |
          # Find directories that look like versions (e.g., 2.2.1.1)
          # Sort numerically/version-wise to get the latest
          $LATEST_VERSION = Get-ChildItem -Directory | Where-Name -Match '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name
          
          if (-not $LATEST_VERSION) {
            Write-Error "No version directories found."
            exit 1
          }
          
          Write-Host "Latest version directory found: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $env:GITHUB_OUTPUT

      - name: Deploy to Yak
        uses: crashcloud/yak-publish@main
        with:
          package-name: "Urbano2"
          token: ${{ secrets.YAK_TOKEN }}
          # Pointing to the version directory where manifest.yml and yak file reside
          build-path: "${{ steps.find_version.outputs.version }}/**"
          publish: 'production' # Publish to live server
          platform: 'any' # Or specific if needed, but 'any' is good for .gha usually
